name: CI with Ollama

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Create test environment
      run: |
        echo "CHAT_PROVIDER=ollama" > .env
        echo "CHAT_MODEL=mistral" >> .env
        echo "OLLAMA_HOST=http://localhost:11434" >> .env

    - name: Install Ollama
      uses: ai-action/ollama-action@v1
      with:
        model: mistral

    - name: Verify Ollama setup
      run: |
        echo "Checking Ollama status..."
        curl -s http://localhost:11434/api/tags | jq '.models[0].name'

    - name: Run Ollama client tests
      run: |
        timeout 30 python test_ollama.py

    - name: Run pytest tests
      run: |
        python -m pytest -v --tb=short -m "not integration"

    - name: Run integration tests (with Ollama)
      run: |
        python -m pytest -v --tb=short -m integration